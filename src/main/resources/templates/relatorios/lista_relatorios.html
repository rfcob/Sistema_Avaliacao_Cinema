<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{layout :: head}"></head>
<body>
<header th:replace="~{layout :: header}"></header>
<aside th:replace="~{layout :: sidebar}"></aside>

<main id="main" class="main">
    <div class="pagetitle">
        <h1>Relatórios e Gráficos</h1>
        <nav>
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a th:href="@{/}">Home</a></li>
                <li class="breadcrumb-item active">Relatórios</li>
            </ol>
        </nav>
    </div>

    <section class="section">
        <!-- Alertas -->
        <div th:if="${success}" class="alert alert-success alert-dismissible fade show">
            <i class="bi bi-check-circle me-2"></i>
            <span th:text="${success}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        <div th:if="${error}" class="alert alert-danger alert-dismissible fade show">
            <i class="bi bi-exclamation-triangle me-2"></i>
            <span th:text="${error}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>

        <!-- Card de Filtros -->
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="bi bi-funnel me-2"></i>Filtrar e Gerar Relatórios
                </h5>

                <!-- Formulário de Filtros -->
                <form id="formFiltros" th:action="@{/relatorios/filtrar}" method="post" class="row g-3 align-items-end">
                    <!-- Filtros -->
                    <div class="col-md-3">
                        <label class="form-label">Data Início</label>
                        <input type="date" name="inicio" class="form-control"
                               th:value="${filtroInicio}">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Data Fim</label>
                        <input type="date" name="fim" class="form-control"
                               th:value="${filtroFim}">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Faixa Etária</label>
                        <select name="faixaEtaria" class="form-select">
                            <option value="">Todas</option>
                            <option value="18-25" th:selected="${filtroFaixaEtaria == '18-25'}">18-25</option>
                            <option value="26-35" th:selected="${filtroFaixaEtaria == '26-35'}">26-35</option>
                            <option value="36-45" th:selected="${filtroFaixaEtaria == '36-45'}">36-45</option>
                            <option value=">45" th:selected="${filtroFaixaEtaria == '>45'}">Acima de 45</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Cinema</label>
                        <select name="idCinema" class="form-select">
                            <option value="">Todos</option>
                            <option th:each="cinema : ${cinemas}"
                                    th:value="${cinema.idCinema}"
                                    th:text="${cinema.nome}"
                                    th:selected="${filtroIdCinema == cinema.idCinema}">
                            </option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Tipo de Sala</label>
                        <select name="tipoSala" class="form-select">
                            <option value="">Todas</option>
                            <option value="VIP" th:selected="${filtroTipoSala == 'VIP'}">VIP</option>
                            <option value="IMAX" th:selected="${filtroTipoSala == 'IMAX'}">IMAX</option>
                            <option value="Convencional" th:selected="${filtroTipoSala == 'Convencional'}">Convencional</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Sentimento</label>
                        <select name="sentimento" class="form-select">
                            <option value="">Todos</option>
                            <option value="positivo" th:selected="${filtroSentimento == 'positivo'}">Positivo</option>
                            <option value="negativo" th:selected="${filtroSentimento == 'negativo'}">Negativo</option>
                            <option value="neutro" th:selected="${filtroSentimento == 'neutro'}">Neutro</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Filme</label>
                        <select name="idFilme" class="form-select">
                            <option value="">Todos</option>
                            <option th:each="filme : ${filmes}"
                                    th:value="${filme.idFilme}"
                                    th:text="${filme.titulo}"
                                    th:selected="${filtroIdFilme == filme.idFilme}">
                            </option>
                        </select>
                    </div>

                    <!-- Tipo de Relatório -->
                    <div class="col-md-3">
                        <label class="form-label">Tipo de Relatório</label>
                        <select name="tipoRelatorio" class="form-select">
                            <option value="completo" th:selected="${tipoRelatorio == 'completo'}">Relatório Completo</option>
                            <option value="medias_criterios" th:selected="${tipoRelatorio == 'medias_criterios'}">Médias por Critério</option>
                            <option value="distribuicao_cinemas" th:selected="${tipoRelatorio == 'distribuicao_cinemas'}">Avaliações por Cinema</option>
                            <option value="evolucao_temporal" th:selected="${tipoRelatorio == 'evolucao_temporal'}">Evolução Temporal</option>
                            <option value="notas_por_sala" th:selected="${tipoRelatorio == 'notas_por_sala'}">Notas por Tipo de Sala</option>
                            <option value="sentimentos" th:selected="${tipoRelatorio == 'sentimentos'}">Sentimentos dos Comentários</option>
                            <option value="avaliacoes_por_filme" th:selected="${tipoRelatorio == 'avaliacoes_por_filme'}">Avaliações por Filme</option>
                            <option value="avaliacoes_por_faixa" th:selected="${tipoRelatorio == 'avaliacoes_por_faixa'}">Avaliações por Faixa Etária</option>
                            <option value="avaliacoes_por_hora" th:selected="${tipoRelatorio == 'avaliacoes_por_hora'}">Avaliações por Hora do Dia</option>
                        </select>
                    </div>

                    <!-- Todos os botões lado a lado -->
                    <div class="row mt-3 text-center">
                        <!-- Botão 1: Aplicar Filtros -->
                        <div class="col-3">
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="bi bi-funnel me-1"></i> Aplicar Filtros e Gerar
                            </button>
                        </div>

                        <!-- Botão 2: Limpar Filtros -->
                        <div class="col-3">
                            <button type="button" class="btn btn-outline-secondary w-100" onclick="limparFiltros()">
                                <i class="bi bi-arrow-clockwise me-1"></i> Limpar Filtros
                            </button>
                        </div>

                        <!-- Botão 3: Gerar Completo sem Filtros -->
                        <div class="col-3">
                            <button type="button" class="btn btn-success w-100" onclick="gerarCompleto()">
                                <i class="bi bi-graph-up me-1"></i> Gerar Completo sem Filtros
                            </button>
                        </div>

                        <!-- Botão 4: Limpar Gráficos -->
                        <div class="col-3">
                            <button type="button" class="btn btn-warning w-100" onclick="limparGraficos()">
                                <i class="bi bi-trash me-1"></i> Limpar Gráficos
                            </button>
                        </div>
                    </div>
                </form>

                <!-- Formulários ocultos para ações específicas -->
                <form id="formCompleto" th:action="@{/relatorios/gerar}" method="post" style="display: none;">
                    <input type="hidden" name="tipoRelatorio" value="completo">
                </form>

                <form id="formLimpar" th:action="@{/relatorios/limpar}" method="post" style="display: none;">
                </form>

                <!-- Indicador de Filtros Ativos - CORRIGIDO COM VERIFICAÇÕES DE NULIDADE -->
                <div th:if="${filtrosAplicados}" class="mt-3">
                    <div class="alert alert-info py-2">
                        <small>
                            <i class="bi bi-info-circle me-1"></i>
                            <strong>Filtros aplicados:</strong>

                            <!-- Data Início -->
                            <span th:if="${filtroInicio != null}">
                                De <span th:text="${#temporals.format(filtroInicio, 'dd/MM/yyyy')}"></span>
                            </span>

                            <!-- Data Fim -->
                            <span th:if="${filtroFim != null}">
                                <span th:if="${filtroInicio != null}">até</span>
                                <span th:if="${filtroInicio == null}">Até</span>
                                <span th:text="${#temporals.format(filtroFim, 'dd/MM/yyyy')}"></span>
                            </span>

                            <!-- Faixa Etária -->
                            <span th:if="${filtroFaixaEtaria != null and filtroFaixaEtaria != ''}">
                                <span th:if="${filtroInicio != null or filtroFim != null}">|</span>
                                Faixa: <span th:text="${filtroFaixaEtaria}"></span>
                            </span>

                            <!-- Tipo de Sala -->
                            <span th:if="${filtroTipoSala != null and filtroTipoSala != ''}">
                                <span th:if="${filtroInicio != null or filtroFim != null or (filtroFaixaEtaria != null and filtroFaixaEtaria != '')}">|</span>
                                Sala: <span th:text="${filtroTipoSala}"></span>
                            </span>

                            <!-- Sentimento -->
                            <span th:if="${filtroSentimento != null and filtroSentimento != ''}">
                                <span th:if="${filtroInicio != null or filtroFim != null or (filtroFaixaEtaria != null and filtroFaixaEtaria != '') or (filtroTipoSala != null and filtroTipoSala != '')}">|</span>
                                Sentimento: <span th:text="${filtroSentimento}"></span>
                            </span>

                            <!-- Cinema -->
                            <span th:if="${filtroIdCinema != null}">
                                <span th:if="${filtroInicio != null or filtroFim != null or (filtroFaixaEtaria != null and filtroFaixaEtaria != '') or (filtroTipoSala != null and filtroTipoSala != '') or (filtroSentimento != null and filtroSentimento != '')}">|</span>
                                Cinema:
                                <span th:each="cinema : ${cinemas}"
                                      th:if="${cinema.idCinema == filtroIdCinema}"
                                      th:text="${cinema.nome}"></span>
                            </span>

                            <!-- Filme -->
                            <span th:if="${filtroIdFilme != null}">
                                <span th:if="${filtroInicio != null or filtroFim != null or (filtroFaixaEtaria != null and filtroFaixaEtaria != '') or (filtroTipoSala != null and filtroTipoSala != '') or (filtroSentimento != null and filtroSentimento != '') or filtroIdCinema != null}">|</span>
                                Filme:
                                <span th:each="filme : ${filmes}"
                                      th:if="${filme.idFilme == filtroIdFilme}"
                                      th:text="${filme.titulo}"></span>
                            </span>

                            <!-- Se nenhum filtro específico foi aplicado, mostra uma mensagem genérica -->
                            <span th:if="${filtroInicio == null and filtroFim == null and (filtroFaixaEtaria == null or filtroFaixaEtaria == '') and (filtroTipoSala == null or filtroTipoSala == '') and (filtroSentimento == null or filtroSentimento == '') and filtroIdCinema == null and filtroIdFilme == null}">
                                Todos os filtros padrão
                            </span>
                        </small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Seção de Gráficos - CORRIGIDA E COMPLETA -->
        <div th:if="${temGraficos}" class="row mt-4">

            <!-- RELATÓRIO COMPLETO - Todos os gráficos -->
            <div th:if="${tipoRelatorio == 'completo'}">
                <!-- Médias por Critério -->
                <div class="col-xxl-6 col-xl-6 mb-4">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Médias por Critério de Avaliação</h5>
                            <div class="text-center">
                                <img th:src="@{/relatorios/imagens/medias_criterios.png(v=${versaoGraficos})}"
                                     class="img-fluid rounded shadow"
                                     alt="Gráfico de médias por critério"
                                     style="max-height: 400px;">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Avaliações por Cinema -->
                <div class="col-xxl-6 col-xl-6 mb-4">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Distribuição de Avaliações por Cinema</h5>
                            <div class="text-center">
                                <img th:src="@{/relatorios/imagens/distribuicao_cinemas.png(v=${versaoGraficos})}"
                                     class="img-fluid rounded shadow"
                                     alt="Gráfico de distribuição por cinema"
                                     style="max-height: 400px;">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Evolução Temporal -->
                <div class="col-xxl-6 col-xl-6 mb-4">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Evolução Temporal das Avaliações</h5>
                            <div class="text-center">
                                <img th:src="@{/relatorios/imagens/evolucao_temporal.png(v=${versaoGraficos})}"
                                     class="img-fluid rounded shadow"
                                     alt="Gráfico de evolução temporal"
                                     style="max-height: 400px;">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Notas por Tipo de Sala -->
                <div class="col-xxl-6 col-xl-6 mb-4">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Notas por Tipo de Sala</h5>
                            <div class="text-center">
                                <img th:src="@{/relatorios/imagens/notas_por_sala.png(v=${versaoGraficos})}"
                                     class="img-fluid rounded shadow"
                                     alt="Gráfico de notas por tipo de sala"
                                     style="max-height: 400px;">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sentimentos -->
                <div class="col-xxl-6 col-xl-6 mb-4">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Sentimentos dos Comentários</h5>
                            <div class="text-center">
                                <img th:src="@{/relatorios/imagens/sentimentos.png(v=${versaoGraficos})}"
                                     class="img-fluid rounded shadow"
                                     alt="Gráfico de sentimentos"
                                     style="max-height: 400px;">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Avaliações por Filme -->
                <div class="col-xxl-6 col-xl-6 mb-4">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Avaliações por Filme</h5>
                            <div class="text-center">
                                <img th:src="@{/relatorios/imagens/avaliacoes_por_filme.png(v=${versaoGraficos})}"
                                     class="img-fluid rounded shadow"
                                     alt="Gráfico de avaliações por filme"
                                     style="max-height: 400px;">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Avaliações por Faixa Etária -->
                <div class="col-xxl-6 col-xl-6 mb-4">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Avaliações por Faixa Etária</h5>
                            <div class="text-center">
                                <img th:src="@{/relatorios/imagens/avaliacoes_por_faixa.png(v=${versaoGraficos})}"
                                     class="img-fluid rounded shadow"
                                     alt="Gráfico de avaliações por faixa etária"
                                     style="max-height: 400px;">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Avaliações por Hora do Dia -->
                <div class="col-xxl-6 col-xl-6 mb-4">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Avaliações por Hora do Dia</h5>
                            <div class="text-center">
                                <img th:src="@{/relatorios/imagens/avaliacoes_por_hora.png(v=${versaoGraficos})}"
                                     class="img-fluid rounded shadow"
                                     alt="Gráfico de avaliações por hora do dia"
                                     style="max-height: 400px;">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- RELATÓRIOS ESPECÍFICOS - Um gráfico por vez -->

            <!-- Médias por Critério - Específico -->
            <div th:if="${tipoRelatorio == 'medias_criterios'}" class="col-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Médias por Critério de Avaliação</h5>
                        <div class="text-center">
                            <img th:src="@{/relatorios/imagens/medias_criterios.png(v=${versaoGraficos})}"
                                 class="img-fluid rounded shadow"
                                 alt="Gráfico de médias por critério"
                                 style="max-height: 500px;">
                            <div class="mt-2">
                                <small class="text-muted">
                                    <i class="bi bi-filter"></i>
                                    <span th:if="${filtrosAplicados}">Com filtros aplicados</span>
                                    <span th:if="${not filtrosAplicados}">Sem filtros aplicados</span>
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Distribuição por Cinema - Específico -->
            <div th:if="${tipoRelatorio == 'distribuicao_cinemas'}" class="col-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Distribuição de Avaliações por Cinema</h5>
                        <div class="text-center">
                            <img th:src="@{/relatorios/imagens/distribuicao_cinemas.png(v=${versaoGraficos})}"
                                 class="img-fluid rounded shadow"
                                 alt="Gráfico de distribuição por cinema"
                                 style="max-height: 500px;">
                            <div class="mt-2">
                                <small class="text-muted">
                                    <i class="bi bi-filter"></i>
                                    <span th:if="${filtrosAplicados}">Com filtros aplicados</span>
                                    <span th:if="${not filtrosAplicados}">Sem filtros aplicados</span>
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Evolução Temporal - Específico -->
            <div th:if="${tipoRelatorio == 'evolucao_temporal'}" class="col-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Evolução Temporal das Avaliações</h5>
                        <div class="text-center">
                            <img th:src="@{/relatorios/imagens/evolucao_temporal.png(v=${versaoGraficos})}"
                                 class="img-fluid rounded shadow"
                                 alt="Gráfico de evolução temporal"
                                 style="max-height: 500px;">
                            <div class="mt-2">
                                <small class="text-muted">
                                    <i class="bi bi-filter"></i>
                                    <span th:if="${filtrosAplicados}">Com filtros aplicados</span>
                                    <span th:if="${not filtrosAplicados}">Sem filtros aplicados</span>
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Notas por Tipo de Sala - Específico -->
            <div th:if="${tipoRelatorio == 'notas_por_sala'}" class="col-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Notas por Tipo de Sala</h5>
                        <div class="text-center">
                            <img th:src="@{/relatorios/imagens/notas_por_sala.png(v=${versaoGraficos})}"
                                 class="img-fluid rounded shadow"
                                 alt="Gráfico de notas por tipo de sala"
                                 style="max-height: 500px;">
                            <div class="mt-2">
                                <small class="text-muted">
                                    <i class="bi bi-filter"></i>
                                    <span th:if="${filtrosAplicados}">Com filtros aplicados</span>
                                    <span th:if="${not filtrosAplicados}">Sem filtros aplicados</span>
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sentimentos - Específico -->
            <div th:if="${tipoRelatorio == 'sentimentos'}" class="col-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Sentimentos dos Comentários</h5>
                        <div class="text-center">
                            <img th:src="@{/relatorios/imagens/sentimentos.png(v=${versaoGraficos})}"
                                 class="img-fluid rounded shadow"
                                 alt="Gráfico de sentimentos"
                                 style="max-height: 500px;">
                            <div class="mt-2">
                                <small class="text-muted">
                                    <i class="bi bi-filter"></i>
                                    <span th:if="${filtrosAplicados}">Com filtros aplicados</span>
                                    <span th:if="${not filtrosAplicados}">Sem filtros aplicados</span>
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Avaliações por Filme - Específico -->
            <div th:if="${tipoRelatorio == 'avaliacoes_por_filme'}" class="col-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Avaliações por Filme</h5>
                        <div class="text-center">
                            <img th:src="@{/relatorios/imagens/avaliacoes_por_filme.png(v=${versaoGraficos})}"
                                 class="img-fluid rounded shadow"
                                 alt="Gráfico de avaliações por filme"
                                 style="max-height: 500px;">
                            <div class="mt-2">
                                <small class="text-muted">
                                    <i class="bi bi-filter"></i>
                                    <span th:if="${filtrosAplicados}">Com filtros aplicados</span>
                                    <span th:if="${not filtrosAplicados}">Sem filtros aplicados</span>
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Avaliações por Faixa Etária - Específico -->
            <div th:if="${tipoRelatorio == 'avaliacoes_por_faixa'}" class="col-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Avaliações por Faixa Etária</h5>
                        <div class="text-center">
                            <img th:src="@{/relatorios/imagens/avaliacoes_por_faixa.png(v=${versaoGraficos})}"
                                 class="img-fluid rounded shadow"
                                 alt="Gráfico de avaliações por faixa etária"
                                 style="max-height: 500px;">
                            <div class="mt-2">
                                <small class="text-muted">
                                    <i class="bi bi-filter"></i>
                                    <span th:if="${filtrosAplicados}">Com filtros aplicados</span>
                                    <span th:if="${not filtrosAplicados}">Sem filtros aplicados</span>
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Avaliações por Hora do Dia - Específico -->
            <div th:if="${tipoRelatorio == 'avaliacoes_por_hora'}" class="col-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Avaliações por Hora do Dia</h5>
                        <div class="text-center">
                            <img th:src="@{/relatorios/imagens/avaliacoes_por_hora.png(v=${versaoGraficos})}"
                                 class="img-fluid rounded shadow"
                                 alt="Gráfico de avaliações por hora do dia"
                                 style="max-height: 500px;">
                            <div class="mt-2">
                                <small class="text-muted">
                                    <i class="bi bi-filter"></i>
                                    <span th:if="${filtrosAplicados}">Com filtros aplicados</span>
                                    <span th:if="${not filtrosAplicados}">Sem filtros aplicados</span>
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <!-- Estado Vazio -->
        <div th:unless="${temGraficos}" class="text-center mt-5">
            <div class="card">
                <div class="card-body py-5">
                    <i class="bi bi-graph-up display-1 text-muted"></i>
                    <h4 class="text-muted mt-3">Nenhum relatório gerado</h4>
                    <p class="text-muted">Use os filtros acima para gerar relatórios personalizados ou clique em "Gerar Completo" para ver todos os dados.</p>
                    <button type="button" class="btn btn-primary mt-2" onclick="gerarCompleto()">
                        <i class="bi bi-graph-up me-1"></i> Gerar Primeiro Relatório
                    </button>
                </div>
            </div>
        </div>
    </section>
</main>

<script>
    function limparFiltros() {
        const form = document.getElementById('formFiltros');
        const inputs = form.querySelectorAll('input, select, textarea');

        inputs.forEach(input => {
            if (input.type === 'text' || input.type === 'date' || input.tagName === 'TEXTAREA') {
                input.value = '';
            } else if (input.tagName === 'SELECT') {
                input.selectedIndex = 0;
            }
        });

        // Define o tipo de relatório como completo
        const tipoRelatorioSelect = form.querySelector('select[name="tipoRelatorio"]');
        if (tipoRelatorioSelect) {
            tipoRelatorioSelect.value = 'completo';
        }
    }

    function gerarCompleto() {
        document.getElementById('formCompleto').submit();
    }

    function limparGraficos() {
        document.getElementById('formLimpar').submit();
    }
</script>
</body>
</html>